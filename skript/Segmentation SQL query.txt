query = """
WITH
sessions_2023 AS (
  SELECT *
  FROM sessions s
  WHERE s.session_start > '2023-01-04'
),
filtered_users AS (
  SELECT
    user_id,
    COUNT(*) AS session_count
  FROM sessions_2023 s
  GROUP BY user_id
  HAVING COUNT(*) > 7
),
session_base AS (
  SELECT
    s.session_id,
    s.user_id,
    s.trip_id,
    s.session_start, s.session_end,
    s.page_clicks,
    s.flight_discount, s.flight_discount_amount,
    s.hotel_discount, s.hotel_discount_amount,
    s.flight_booked, s.hotel_booked,
    s.cancellation,
    u.birthdate, u.gender, u.married, u.has_children,
    u.home_country, u.home_city, u.home_airport,
    u.home_airport_lat, u.home_airport_lon,
    u.sign_up_date,
    f.origin_airport, f.destination, f.destination_airport,
    f.seats, f.return_flight_booked,
    f.departure_time, f.return_time,
    f.checked_bags, f.trip_airline,
    f.destination_airport_lat, f.destination_airport_lon,
    f.base_fare_usd,
    h.hotel_name, h.nights, h.rooms,
    h.check_in_time, h.check_out_time,
    h.hotel_per_room_usd AS hotel_price_per_room_night_usd
  FROM sessions_2023 s
  INNER JOIN users u ON s.user_id = u.user_id
  LEFT JOIN flights f ON s.trip_id = f.trip_id
  LEFT JOIN hotels h ON s.trip_id = h.trip_id
  WHERE
      s.user_id IN (SELECT user_id FROM filtered_users)
    AND
      (h.nights IS NULL OR h.nights > 0)
    AND
      ((h.check_in_time IS NULL AND h.check_out_time IS NULL) OR h.check_out_time > h.check_in_time)
),
user_agg_features AS (
  SELECT
    sb.user_id AS user_id,
    COUNT(DISTINCT sb.session_id) AS total_number_of_sessions,
    SUM(sb.page_clicks) AS total_page_clicks,
    AVG(sb.page_clicks) AS avg_page_clicks,
    SUM(CASE WHEN sb.flight_booked::int = 1 AND sb.cancellation::int = 0 THEN 1 ELSE 0 END) AS flights_booked_and_not_cancelled,
    SUM(CASE WHEN sb.hotel_booked::int = 1 AND sb.cancellation::int = 0 THEN 1 ELSE 0 END) AS hotels_booked_and_not_cancelled,
    SUM(CASE WHEN sb.cancellation::int = 1 THEN 1 ELSE 0 END) AS total_cancellations,
    COUNT(DISTINCT sb.trip_id) AS total_trips,
    AVG(CASE WHEN sb.flight_discount::int = 1 AND sb.cancellation::int = 0 THEN sb.checked_bags ELSE NULL END) AS avg_checked_bags,
    AVG(CASE WHEN sb.flight_discount::int = 1 AND sb.cancellation::int = 0 THEN sb.seats ELSE NULL END) AS avg_seats,
    AVG(CASE WHEN sb.flight_discount::int = 1 AND sb.cancellation::int = 0 THEN 1.0 ELSE 0.0 END) * 100 AS pct_discounted_flights,
    AVG(CASE WHEN sb.hotel_discount::int = 1 AND sb.cancellation::int = 0 THEN 1.0 ELSE 0.0 END) * 100 AS pct_discounted_hotels,
    AVG(CASE WHEN sb.flight_discount::int = 1 AND sb.cancellation::int = 0 THEN sb.flight_discount_amount ELSE NULL END) AS avg_flights_discount,
    AVG(CASE WHEN sb.hotel_discount::int = 1 AND sb.cancellation::int = 0 THEN sb.hotel_discount_amount ELSE NULL END) AS avg_hotel_discount,
    AVG(CASE WHEN sb.flight_booked::int = 1 AND sb.cancellation::int = 0 THEN sb.base_fare_usd ELSE NULL END) AS avg_flights_spending,
    AVG(CASE WHEN sb.hotel_booked::int = 1 AND sb.cancellation::int = 0 THEN sb.hotel_price_per_room_night_usd ELSE NULL END) AS avg_hotel_spending,
    AVG(CASE WHEN sb.hotel_booked::int = 1 AND sb.cancellation::int = 0 THEN sb.nights ELSE NULL END) AS avg_nights_spend,
    AVG(CASE WHEN sb.hotel_booked::int = 1 AND sb.cancellation::int = 0 THEN sb.rooms ELSE NULL END) AS avg_rooms_taken,
    AVG(CASE WHEN sb.return_flight_booked::int = 1 AND sb.cancellation::int = 0 THEN 1 ELSE 0 END) AS avg_return_flight_booked,
    AVG(sb.session_end - sb.session_start) AS avg_session_duration,
    AVG(sb.departure_time - sb.session_end) AS avg_time_to_flight,
    AVG(sb.return_time - sb.departure_time) AS avg_trip_duration,
    COUNT(DISTINCT CASE WHEN sb.flight_booked::int = 1 AND sb.cancellation::int = 0 THEN sb.trip_airline ELSE NULL END) AS trips_taken,
    DATE_PART('year', AGE(MAX(sb.birthdate)))::int AS age,
    MAX(sb.gender) AS gender,
    MAX(sb.married::int) AS married,
    MAX(sb.has_children::int) AS has_children,
    MAX(sb.home_country) AS home_country,
    MAX(sb.home_city) AS home_city,
    MAX(sb.home_airport) AS home_airport,
    MAX(sb.home_airport_lat) AS home_airport_lat,
    MAX(sb.home_airport_lon) AS home_airport_lon,
    MAX(sb.sign_up_date) AS sign_up_date,
    MAX(sb.session_end) AS latest_session,
    MIN(sb.session_start) AS earliest_session
    FROM session_base sb
    GROUP BY sb.user_id
)
SELECT * FROM user_agg_features;
"""